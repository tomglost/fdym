// Configuration
const API_URL = 'https://worker1.tomgloster-aus.workers.dev/';

// Activity definitions
const activities = {
    row: { multiplier: 0.75, unit: 'km', label: 'Row' },
    run: { multiplier: 1.5, unit: 'km', label: 'Run' },
    swim: { multiplier: 2.5, unit: 'km', label: 'Swim' },
    bike: { multiplier: 0.5, unit: 'km', label: 'Bike' },
    walk: { multiplier: 0.5, unit: 'km', label: 'Walk' },
    stairmaster: { multiplier: 2, unit: '1000 steps', label: 'Stairmaster' },
    gym: { multiplier: 3, unit: 'hour', label: 'Gym/Pilates' },
    tennis: { multiplier: 4, unit: 'hour', label: 'Tennis/Soccer' },
    basketball_training: { multiplier: 3, unit: 'hour', label: 'Basketball Training' },
    basketball_game: { multiplier: 4, unit: 'hour', label: 'Basketball Game' }
};

// Global state
let participants = {};
let activities_log = [];
let isConnected = false;
let autoRefreshInterval;

// Update connection status
function updateConnectionStatus(status, message) {
    const statusElement = document.getElementById('connectionStatus');
    statusElement.className = `connection-status ${status}`;
    
    const icons = {
        connecting: '🔄',
        connected: '✅',
        error: '❌'
    };
    
    statusElement.innerHTML = `${icons[status]} ${message}`;
}

// API call helper - FIXED VERSION
async function callAPI(action, data = {}) {
    try {
        console.log('Calling API with action:', action, 'data:', data);
        
        const url = `${API_URL}?action=${action}`;
        
        const options = {
            method: 'GET', // Default to GET
            mode: 'cors',
            headers: {
                'Content-Type': 'application/json',
            }
        };

        // Only use POST if we have data to send
        if (data && Object.keys(data).length > 0) {
            options.method = 'POST';
            options.body = JSON.stringify({ action, ...data });
        }

        console.log('Fetch URL:', url);
        console.log('Fetch options:', options);

        const response = await fetch(url, options);
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('API response:', result);
        
        return result;
    } catch (error) {
        console.error('API call failed:', error);
        console.error('Error details:', error.message);
        throw error;
    }
}

// Load leaderboard data
async function loadLeaderboard() {
    try {
        console.log('Loading leaderboard...');
        const result = await callAPI('getLeaderboard');
        
        console.log('Leaderboard result:', result);
        
        if (result.success) {
            participants = result.participants;
            console.log('Participants loaded:', participants);
            updateLeaderboard();
            
            if (!isConnected) {
                isConnected = true;
                updateConnectionStatus('connected', 'Connected to Google Sheets! Data syncs in real-time.');
                startAutoRefresh();
            }
        } else {
            throw new Error(result.error || 'Failed to load leaderboard');
        }
    } catch (error) {
        console.error('Error loading leaderboard:', error);
        updateConnectionStatus('error', 'Connection failed: ' + error.message);
    }
}

// Load activities data
async function loadActivities() {
    try {
        console.log('Loading activities...');
        const result = await callAPI('getActivities');
        
        console.log('Activities result:', result);
        
        if (result.success) {
            activities_log = result.activities || [];
            console.log('Activities loaded:', activities_log);
            updateActivityLog();
        } else {
            throw new Error(result.error || 'Failed to load activities');
        }
    } catch (error) {
        console.error('Error loading activities:', error);
        // Don't show error for activities if leaderboard works
        if (!isConnected) {
            updateConnectionStatus('error', 'Connection failed: ' + error.message);
        }
    }
}

// Save activity to Google Sheets
async function saveActivity(participant, activityType, amount) {
    const activity = activities[activityType];
    const points = amount * activity.multiplier;
    const timestamp = new Date().toISOString();
    
    const activityData = {
        id: Date.now(),
        participant,
        activity: activity.label,
        amount,
        unit: activity.unit,
        points,
        timestamp
    };

    try {
        console.log('Saving activity:', activityData);
        const result = await callAPI('addActivity', activityData);
        
        if (result.success) {
            console.log('Activity saved successfully');
            // Refresh data to show the new activity
            await refreshData();
            return true;
        } else {
            throw new Error(result.error || 'Failed to save activity');
        }
    } catch (error) {
        console.error('Error saving activity:', error);
        alert('Failed to save activity: ' + error.message);
        return false;
    }
}

// Refresh all data
async function refreshData() {
    console.log('Refreshing all data...');
    const container = document.querySelector('.container');
    container.classList.add('loading');
    
    try {
        await Promise.all([
            loadLeaderboard(),
            loadActivities()
        ]);
        updateLastUpdated();
        console.log('Data refresh completed');
    } catch (error) {
        console.error('Error refreshing data:', error);
    } finally {
        container.classList.remove('loading');
    }
}

// Update last updated timestamp
function updateLastUpdated() {
    const now = new Date();
    const lastUpdatedElement = document.getElementById('lastUpdated');
    if (lastUpdatedElement) {
        lastUpdatedElement.textContent = `Last updated: ${now.toLocaleTimeString()}`;
    }
}

// Start auto-refresh
function startAutoRefresh() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    autoRefreshInterval = setInterval(refreshData, 30000); // 30 seconds
    console.log('Auto-refresh started');
}

// Update distance label based on selected activity
function updateDistanceLabel() {
    const activityType = document.getElementById('activityType').value;
    const distanceLabel = document.getElementById('distanceLabel');
    const distanceHint = document.getElementById('distanceHint');
    const distanceInput = document.getElementById('distance');

    if (activityType && activities[activityType]) {
        const activity = activities[activityType];
        distanceLabel.textContent = `Amount (${activity.unit})`;
        distanceHint.textContent = `${activity.multiplier} points per ${activity.unit}`;
        
        if (activity.unit === 'hour') {
            distanceInput.step = '0.25';
            distanceInput.placeholder = 'e.g., 1.5';
        } else if (activity.unit === '1000 steps') {
            distanceInput.step = '1';
            distanceInput.placeholder = 'e.g., 8 (for 8000 steps)';
        } else {
            distanceInput.step = '0.1';
            distanceInput.placeholder = 'e.g., 5.0';
        }
    } else {
        distanceLabel.textContent = 'Amount';
        distanceHint.textContent = '';
        distanceInput.placeholder = '';
    }
}

// Update leaderboard display
function updateLeaderboard() {
    console.log('Updating leaderboard display with participants:', participants);
    const leaderboardContent = document.getElementById('leaderboardContent');
    
    const sortedParticipants = Object.entries(participants)
        .sort(([,a], [,b]) => b.totalPoints - a.totalPoints);

    console.log('Sorted participants:', sortedParticipants);

    if (sortedParticipants.length === 0) {
        leaderboardContent.innerHTML = '<div class="empty-state">No activities recorded yet. Add some activities to see the leaderboard!</div>';
        return;
    }

    let html = '';
    sortedParticipants.forEach(([name, data], index) => {
        const rank = index + 1;
        let rankClass = '';
        let rankDisplay = `#${rank}`;
        
        if (rank === 1 && data.totalPoints > 0) {
            rankClass = 'gold';
            rankDisplay = '🥇';
        } else if (rank === 2 && data.totalPoints > 0) {
            rankClass = 'silver';
            rankDisplay = '🥈';
        } else if (rank === 3 && data.totalPoints > 0) {
            rankClass = 'bronze';
            rankDisplay = '🥉';
        }

        html += `
            <div class="leaderboard-item">
                <div class="rank ${rankClass}">${rankDisplay}</div>
                <div class="participant-name">${name}</div>
                <div class="points">${data.totalPoints.toFixed(1)} pts</div>
            </div>
        `;
    });

    leaderboardContent.innerHTML = html;
}

// Update activity log display
function updateActivityLog() {
    console.log('Updating activity log with activities:', activities_log);
    const activityLogContent = document.getElementById('activityLogContent');
    
    if (!activities_log || activities_log.length === 0) {
        activityLogContent.innerHTML = '<div class="empty-state">No activities logged yet. Add an activity above to get started!</div>';
        return;
    }

    let html = '';
    activities_log.slice(0, 20).forEach(activity => {
        const date = new Date(activity.timestamp).toLocaleDateString();
        const time = new Date(activity.timestamp).toLocaleTimeString();
        
        html += `
            <div class="activity-item">
                <div class="activity-header">
                    ${activity.participant} - ${activity.activity}
                </div>
                <div class="activity-details">
                    ${activity.amount} ${activity.unit} • ${parseFloat(activity.points).toFixed(1)} points • ${date} ${time}
                </div>
            </div>
        `;
    });

    activityLogContent.innerHTML = html;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, initializing...');
    updateConnectionStatus('connecting', 'Connecting to Google Sheets...');
    refreshData();
});

// Handle page visibility change (refresh when tab becomes visible)
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && isConnected) {
        console.log('Page became visible, refreshing data...');
        refreshData();
    }
});
